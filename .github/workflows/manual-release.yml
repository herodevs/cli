name: Manual Release
run-name: Release ${{ github.ref_name }} (pushed by ${{ github.actor }})${{ inputs.dry-run == true && ' --dry-run' || '' }}

on:
  workflow_dispatch:
    inputs:
      channel:
        description: 'NPM tag to publish to'
        type: choice
        options:
          - beta
          - alpha
          - latest
          - next
        default: beta
      dry-run:
        description: 'Dry run the release'
        type: boolean
        default: false
permissions:
  contents: read

jobs:
  check:
    name: Check version
    runs-on: ubuntu-latest
    steps:
      - id: version
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
    outputs:
      version: ${{ steps.version.outputs.version }}
  build-binaries:
    strategy:
      matrix:
        include:
          - os: windows-2022
            target: x86_64-pc-windows-msvc
            code-target: win32-x64
          - os: ubuntu-20.04
            target: x86_64-unknown-linux-gnu
            code-target: linux-x64
          - os: macos-14
            target: aarch64-apple-darwin
            code-target: darwin-arm64
    name: Build ${{ matrix.code-target }} binaries
    runs-on: ${{ matrix.os }}
    needs: check
    env:
      version: ${{ needs.check.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Install Node.js
        uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.3.0
        with:
          node-version-file: '.nvmrc'
      - name: Install linux toolchain
        if: matrix.code-target == 'linux-x64'
        run: |
          sudo apt install nsis p7zip-full p7zip-rar -y
      - name: Install win32 toolchain
        if: matrix.code-target == 'win32-x64'
        run: |
          choco install 7zip nsis grep -y
          echo "C:\Program Files (x86)\GnuWin32\bin" >> $GITHUB_PATH
      - name: Install npm dependencies
        run: npm ci
      - name: Build binaries
        run: npm run pack
      - name: Upload binary artifact
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: cli-${{ matrix.code-target }}
          path: ./dist/hd-*
          if-no-files-found: error
  release:
    runs-on: ubuntu-latest
    needs: [check, build-binaries]
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.3.0
        with:
          node-version-file: '.nvmrc'
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci
      - run: npm run build
      - run: npm test
      - run: npm run test:e2e
      - name: Create NPM release
        run: npm publish --tag ${{ inputs.channel }} --provenance --access public ${{ inputs.dry-run == true && '--dry-run' || '' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.HD_CLI_NPM_TOKEN }}
